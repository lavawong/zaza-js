/* Mask | 创新项目假面 | vserion 0.0.1*/
function log(){if(arguments.length){for(var t,e=[],n=document.getElementById("log"),i=document.createElement("p"),o=0,a=arguments.length;a>o;o++)t=arguments[o],"object"==typeof t?e.push(JSON.stringify(t)):e.push(t);i.textContent=e.join(", "),n.appendChild(i)}}var mask=angular.module("mask",["ngRoute","ngTouch","ngAnimate"],["$httpProvider",function(t){t.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded;charset=utf-8";var e=function(t){var n,i,o,a,r,s,c,u="";for(n in t)if(i=t[n],i instanceof Array)for(c=0;i.length>c;++c)r=i[c],o=n+"["+c+"]",s={},s[o]=r,u+=e(s)+"&";else if(i instanceof Object)for(a in i)r=i[a],o=n+"["+a+"]",s={},s[o]=r,u+=e(s)+"&";else void 0!==i&&null!==i&&(u+=encodeURIComponent(n)+"="+encodeURIComponent(i)+"&");return u.length?u.substr(0,u.length-1):u};t.defaults.transformRequest=[function(t){return angular.isObject(t)&&"[object File]"!=t+""?e(t):t}]}]);mask.config(["$httpProvider",function(t){t.interceptors.push("httpRequestInterceptor")}]),mask.factory("API",function(){return{ADD_MASK:"http://yifei2.sinaapp.com//api/secret/add_mimi",ADD_USER:"http://yifei2.sinaapp.com/api/user/add",GET_LIST:"http://yifei2.sinaapp.com/api/secret/getlist",ADD_SECRET_ATT:"http://yifei2.sinaapp.com/api/attitude/add_secret_att",GET_CMT_LIST:"http://yifei2.sinaapp.com/api/comment/getlist",ADD_CMT_ATT:"http://yifei2.sinaapp.com/api/attitude/add_cmt_att",GET_MY_SECRET_LIST:"http://yifei2.sinaapp.com/api/secret/get_my_secret_list",GET_MY_LIST:"http://yifei2.sinaapp.com/api/comment/getMylist",ADD_CMT:"http://yifei2.sinaapp.com/api/comment/add",GET_HOT_PLACE_LIST:"http://yifei2.sinaapp.com/api/hotRecomment/get_hot_place_secret",GET_HOT_TOPIC_LIST:"http://yifei2.sinaapp.com/api/hotRecomment/get_secret_list",GET_HOT_RECOMMENT:"http://yifei2.sinaapp.com/api/hotRecomment/getlist",UPDATE_NICK:"http://yifei2.sinaapp.com/api/user/update_nickname",ADD_SECRET_REPORT:"http://yifei2.sinaapp.com/api/garbage/add_secret_report",DEL_SECRET:"http://yifei2.sinaapp.com/api/secret/del",DEL_CMT:"http://yifei2.sinaapp.com/api/comment/del",SEND_TOKEN:"http://yifei2.sinaapp.com/api/user/add_token",MAP_URL:"http://webapi.amap.com/maps?v=1.3&key=e8fe5b88f7eb073acccb31d0562023fa",SUDA_URL:"http://hits.sinajs.cn/A2/b.html"}}),mask.factory("DeviceApi",function(){return document.addEventListener("deviceready",function(){},!1),{}}),mask.factory("DeviceReady",["$q","API",function(t,e){var n=t.defer(),i=!1,o=function(t){return cordova.require(t)},a=function(){var t=Date.now(),i=document.createElement("script");i.onload=function(){var e=Date.now()-t,o=0,a=setInterval(function(){window.AMap&&(n.resolve(),clearInterval(a)),o>10&&(n.inject({error:"MAP"}),i.abort(),clearInterval(a)),o++},e)},i.onerror=function(){n.inject({error:"MAP"})},i.charset="utf-8",i.src=e.MAP_URL;var o=document.getElementsByTagName("head")[0];o.appendChild(i)},r=function(){if(log("deviceReady:",i),!i){var t={};window.cordova&&(window.device=cordova.plugins.sinauuid,window.socialsharing=o("nl.x-services.plugins.socialsharing.SocialSharing"),t=o("org.apache.cordova.dialogs.notification")),window._alert=window.alert,window._confirm=window.confirm,window.alert=function(e,n){n=n||function(){},t.alert?t.alert(e,n,"\u63d0\u793a","\u786e\u5b9a"):(window._alert(e),n&&n())},window.confirm=function(e,n){if(n=n||function(){},t.confirm)t.confirm(e,n,"\u63d0\u793a",["\u786e\u5b9a","\u53d6\u6d88"]);else{var i=window._confirm(e);n&&n(i?1:2)}};try{i=!0,window.AMap?n.resolve():(log("should get AMap"),a())}catch(e){log(e.message)}}};return document.addEventListener("deviceready",r,!1),window.cordova||window.addEventListener("load",r,!1),n.promise.reRun=function(){a()},n.promise}]),mask.factory("httpRequestInterceptor",["UserData","URI",function(t,e){return{request:function(n){var i=t.data.session_id;return i&&(n.url=""+e(n.url).addSearch({session_id:i})),n}}}]),mask.factory("ListData",function(){return{lists:[],replys:[]}}),mask.factory("Map",["$q",function(t){function e(t){return{longitude:t.longitude+a,latitude:t.latitude+r}}var n,i,o,a=.0064932,r=-869e-6,s={longitude:116.308868,latitude:39.983558},c={longitude:200,latitude:200};return{getCurrentPos:function(){var n=t.defer();return"geolocation"in navigator?navigator.geolocation.getCurrentPosition(function(t){var i=e(t.coords);n.resolve(i)},function(){n.resolve(c)},{maximumAge:6e4,timeout:5e3}):n.resolve(c),n.promise},getPos:function(t){var e=t.longitude,n=t.latitude;return e>180||-180>e||n>90||-90>n?null:new AMap.LngLat(t.longitude,t.latitude)},getMap:function(t,e){if(n)try{n.setCenter(t)}catch(o){}else n=new AMap.Map("map-container",{center:t,level:e||18}),n.plugin(["AMap.ToolBar"],function(){i=new AMap.ToolBar,n.addControl(i)});return n},setMarker:function(t){var e,n=this.getPos(t);n?e=this.getMap(n):(n=this.getPos(s),e=this.getMap(n)),o?(o.show(),o.setPosition(n)):(o=new AMap.Marker({position:n,zIndex:3,offset:new AMap.Pixel(-10,-34),icon:"../style/images/mapicon.png"}),o.setMap(e)),window.marker=o},getDiagonalPoints:function(t){var e=this.getPos(t);if(e){var n=e.offset(3e3,3e3),i=e.offset(-6e3,-6e3);return{northEastPos:{longitude:n.getLng(),latitude:n.getLat()},southWestPos:{longitude:i.getLng(),latitude:i.getLat()},currentPos:{longitude:t.longitude,latitude:t.latitude}}}return{northEastPos:{longitude:200,latitude:200},southWestPos:{longitude:200,latitude:200},currentPos:{longitude:200,latitude:200}}}}}]),mask.factory("MaskDetail",function(){return{detail:{}}}),mask.factory("MaskListType",function(){return{currentType:1,changeType:function(t){this.currentType=t}}}),mask.factory("MD5",function(){var t=function(t){function e(t,e){return t<<e|t>>>32-e}function n(t,e){var n,i,o,a,r;return o=2147483648&t,a=2147483648&e,n=1073741824&t,i=1073741824&e,r=(1073741823&t)+(1073741823&e),n&i?2147483648^r^o^a:n|i?1073741824&r?3221225472^r^o^a:1073741824^r^o^a:r^o^a}function i(t,e,n){return t&e|~t&n}function o(t,e,n){return t&n|e&~n}function a(t,e,n){return t^e^n}function r(t,e,n){return e^(t|~n)}function s(t,o,a,r,s,c,u){return t=n(t,n(n(i(o,a,r),s),u)),n(e(t,c),o)}function c(t,i,a,r,s,c,u){return t=n(t,n(n(o(i,a,r),s),u)),n(e(t,c),i)}function u(t,i,o,r,s,c,u){return t=n(t,n(n(a(i,o,r),s),u)),n(e(t,c),i)}function l(t,i,o,a,s,c,u){return t=n(t,n(n(r(i,o,a),s),u)),n(e(t,c),i)}function d(t){for(var e,n=t.length,i=n+8,o=(i-i%64)/64,a=16*(o+1),r=Array(a-1),s=0,c=0;n>c;)e=(c-c%4)/4,s=8*(c%4),r[e]=r[e]|t.charCodeAt(c)<<s,c++;return e=(c-c%4)/4,s=8*(c%4),r[e]=r[e]|128<<s,r[a-2]=n<<3,r[a-1]=n>>>29,r}function f(t){var e,n,i="",o="";for(n=0;3>=n;n++)e=255&t>>>8*n,o="0"+e.toString(16),i+=o.substr(o.length-2,2);return i}function p(t){t=t.replace(/\r\n/g,"\n");for(var e="",n=0;t.length>n;n++){var i=t.charCodeAt(n);128>i?e+=String.fromCharCode(i):i>127&&2048>i?(e+=String.fromCharCode(192|i>>6),e+=String.fromCharCode(128|63&i)):(e+=String.fromCharCode(224|i>>12),e+=String.fromCharCode(128|63&i>>6),e+=String.fromCharCode(128|63&i))}return e}var g,h,m,v,y,_,k,T,S,D=[],w=7,A=12,M=17,C=22,P=5,L=9,I=14,b=20,E=4,R=11,$=16,N=23,x=6,O=10,q=15,U=21;for(t=p(t),D=d(t),_=1732584193,k=4023233417,T=2562383102,S=271733878,g=0;D.length>g;g+=16)h=_,m=k,v=T,y=S,_=s(_,k,T,S,D[g+0],w,3614090360),S=s(S,_,k,T,D[g+1],A,3905402710),T=s(T,S,_,k,D[g+2],M,606105819),k=s(k,T,S,_,D[g+3],C,3250441966),_=s(_,k,T,S,D[g+4],w,4118548399),S=s(S,_,k,T,D[g+5],A,1200080426),T=s(T,S,_,k,D[g+6],M,2821735955),k=s(k,T,S,_,D[g+7],C,4249261313),_=s(_,k,T,S,D[g+8],w,1770035416),S=s(S,_,k,T,D[g+9],A,2336552879),T=s(T,S,_,k,D[g+10],M,4294925233),k=s(k,T,S,_,D[g+11],C,2304563134),_=s(_,k,T,S,D[g+12],w,1804603682),S=s(S,_,k,T,D[g+13],A,4254626195),T=s(T,S,_,k,D[g+14],M,2792965006),k=s(k,T,S,_,D[g+15],C,1236535329),_=c(_,k,T,S,D[g+1],P,4129170786),S=c(S,_,k,T,D[g+6],L,3225465664),T=c(T,S,_,k,D[g+11],I,643717713),k=c(k,T,S,_,D[g+0],b,3921069994),_=c(_,k,T,S,D[g+5],P,3593408605),S=c(S,_,k,T,D[g+10],L,38016083),T=c(T,S,_,k,D[g+15],I,3634488961),k=c(k,T,S,_,D[g+4],b,3889429448),_=c(_,k,T,S,D[g+9],P,568446438),S=c(S,_,k,T,D[g+14],L,3275163606),T=c(T,S,_,k,D[g+3],I,4107603335),k=c(k,T,S,_,D[g+8],b,1163531501),_=c(_,k,T,S,D[g+13],P,2850285829),S=c(S,_,k,T,D[g+2],L,4243563512),T=c(T,S,_,k,D[g+7],I,1735328473),k=c(k,T,S,_,D[g+12],b,2368359562),_=u(_,k,T,S,D[g+5],E,4294588738),S=u(S,_,k,T,D[g+8],R,2272392833),T=u(T,S,_,k,D[g+11],$,1839030562),k=u(k,T,S,_,D[g+14],N,4259657740),_=u(_,k,T,S,D[g+1],E,2763975236),S=u(S,_,k,T,D[g+4],R,1272893353),T=u(T,S,_,k,D[g+7],$,4139469664),k=u(k,T,S,_,D[g+10],N,3200236656),_=u(_,k,T,S,D[g+13],E,681279174),S=u(S,_,k,T,D[g+0],R,3936430074),T=u(T,S,_,k,D[g+3],$,3572445317),k=u(k,T,S,_,D[g+6],N,76029189),_=u(_,k,T,S,D[g+9],E,3654602809),S=u(S,_,k,T,D[g+12],R,3873151461),T=u(T,S,_,k,D[g+15],$,530742520),k=u(k,T,S,_,D[g+2],N,3299628645),_=l(_,k,T,S,D[g+0],x,4096336452),S=l(S,_,k,T,D[g+7],O,1126891415),T=l(T,S,_,k,D[g+14],q,2878612391),k=l(k,T,S,_,D[g+5],U,4237533241),_=l(_,k,T,S,D[g+12],x,1700485571),S=l(S,_,k,T,D[g+3],O,2399980690),T=l(T,S,_,k,D[g+10],q,4293915773),k=l(k,T,S,_,D[g+1],U,2240044497),_=l(_,k,T,S,D[g+8],x,1873313359),S=l(S,_,k,T,D[g+15],O,4264355552),T=l(T,S,_,k,D[g+6],q,2734768916),k=l(k,T,S,_,D[g+13],U,1309151649),_=l(_,k,T,S,D[g+4],x,4149444226),S=l(S,_,k,T,D[g+11],O,3174756917),T=l(T,S,_,k,D[g+2],q,718787259),k=l(k,T,S,_,D[g+9],U,3951481745),_=n(_,h),k=n(k,m),T=n(T,v),S=n(S,y);var j=f(_)+f(k)+f(T)+f(S);return j.toLowerCase()};return t}),mask.factory("MoreData",function(){return{myLists:[],myReplys:[],type:""}}),mask.factory("PushNotification",["Sence","DeviceReady","$q","MaskDetail",function(t,e,n){var i=null;return function(t){if(!window.cordova||i)return i;window.onNotificationAPN=function(e){log(e),t(e)};var e=window.plugins.pushNotification,o=n.defer();return e.register(function(t){o.resolve(t)},function(){o.reject()},{badge:"true",sound:"true",alert:"true",ecb:"onNotificationAPN"}),i=o.promise}}]),mask.factory("Recomment",function(){return{type:"",id:"",value:"",change:function(t,e,n){this.type=t,this.id=e,this.value=n}}}),mask.factory("RequestData",["$http","$q","Map","API",function(t,e,n,i){return{addSecretAtt:function(n,o){var a=e.defer(),r={secretid:n,attitude:o};return t({method:"POST",url:i.ADD_SECRET_ATT,data:r}).success(function(t){"A00006"==t.code?a.resolve(t.message):a.reject(t)}).error(function(){}),a.promise},addCmtAtt:function(n,o){var a=e.defer(),r={cmtid:n,attitude:o};return t({method:"POST",url:i.ADD_CMT_ATT,data:r}).success(function(t){"A00006"==t.code?a.resolve(t.message):a.reject(t)}).error(function(){}),a.promise},loadData:function(n){var i=e.defer();return t(n).success(function(t){"A00006"==t.code||"A00008"==t.code?i.resolve(t):i.reject(t)}).error(function(){}),i.promise},sudaJsonp:function(n){var o=e.defer(),a={params:{type:n,callback:"JSON_CALLBACK"}};return t.jsonp(i.SUDA_URL,a).success(function(t){o.resolve(t)}).error(function(t){o.reject(t)}),o.promise}}}]),mask.factory("Sence",function(){var t="home",e=[t];return{currentPage:t,changePage:function(t){e.length>1&&t===e[e.length-2]?e.pop():e.push(t),this.currentPage=t},back:function(){e.pop(),e.length>0?this.currentPage=e[e.length-1]:(this.currentPage=t,e.push(t))}}}),mask.factory("ShareData",function(){return{}}),mask.factory("URI",function(){function t(t){this.parse(t)}return t.prototype={constructor:t,params:{},api:"",addSearch:function(t){for(var e in t)t.hasOwnProperty(e)&&(this.params[e]=t[e]);return this},parse:function(t){var e,n,i,o=t.indexOf("?"),a={};if(o>-1){var i,e=t.substring(0,o),n=t.substring(o+1);n.split("&").forEach(function(t){i=t.split("="),a[i[0]]=i[1]||""})}else e=t;return this.params=a,this.api=e,this},toString:function(){var t=[],e=this.params;for(var n in e)e.hasOwnProperty(n)&&t.push(n+"="+e[n]);return this.api+"?"+t.join("&")}},function(e){return new t(e)}}),mask.factory("UserData",function(){return{data:{}}}),mask.filter("changeDistance",function(){return function(t){var e="";return e=100>t?"<100m":t>=100&&500>t?"<500m":t>=500&&1e3>t?"<1km":t>=1e3&&2e3>t?"<2km":">2km"}}),mask.filter("changeTime",function(){return function(t){var e,n,i,o,a,r=(new Date).getTime();return e=r/1e3-t,i=Math.floor(e/60),1>i?n="\u521a\u521a":i>=1&&60>i?n=i+"\u5206\u949f\u524d":i>=60&&1440>i?(o=Math.floor(i/60),n=o+"\u5c0f\u65f6\u524d"):i>=1440&&43200>i?(a=Math.floor(i/1440),n=a+"\u5929\u524d"):n="\u8d85\u8fc730\u5929",n}}),mask.filter("limitCharacters",["byteLength",function(){return function(t,e){return t===void 0?e:e-t.length}}]),mask.filter("outOfLimit",["byteLength",function(){return function(t,e){return t===void 0?e:t.length-e}}]),mask.service("byteLength",function(){var t=function(t){if(t===void 0)return 0;var e=t.match(/[^\x00-\x80]/g);return t.length+(e?e.length:0)};return t}),mask.service("changeTime",function(){return function(t){if(!t)return[];for(var e=(new Date).getTime(),n=0;t.length>n;n++){var i=e-t[n].publishTime,o=Math.floor(i/6e4),a=o+"\u5206\u949f\u524d";t[n].passTime=a}return t}}),mask.directive("autoFocus",["$timeout",function(){return{restrict:"A",link:function(t,e,n){var i=n.autoFocusValue;t.$watch(n.autoFocus,function(t){t==i&&$(e[0]).focus()},!0)}}}]),mask.directive("hotRecomment",["RequestData",function(){return{restrict:"E",templateUrl:"hotRecommentTpl.html",controller:"HotRecommentCtrl",controllerAs:"recmtCtrl"}}]),mask.directive("hotTab",["RequestData",function(){return{restrict:"E",templateUrl:"hotTabTpl.html"}}]),mask.directive("listSet",["$rootScope",function(){return{restrict:"EA",replace:!0,templateUrl:"listTpl.html",link:function(){}}}]),mask.directive("maxCharacterLength",["byteLength",function(t){return{require:"ngModel",link:function(e,n,i,o){var a=2*parseInt(i.maxCharacterLength);o.$parsers.unshift(function(e){var n=t(e);return a>=n?(o.$setValidity("maxCharacterLength",!0),e):(o.$setValidity("maxCharacterLength",!1),e)})}}}]),mask.directive("myReplyList",function(){return{restrict:"EA",replace:!0,templateUrl:"myReplyListTpl.html",link:function(){}}}),mask.directive("pullBottom",function(){return{restrict:"EA",replace:!0,template:'<div class="loading" ng-show="showLoad">loading</div>',link:function(t,e){t.showLoad=!1;var n=e.parent().parent();t.scrollFn=function(){var e=this.scrollHeight,n=this.clientHeight,i=this.scrollTop;n+i==e&&t.$apply(t.toTrue)},t.toTrue=function(){t.showLoad=!0},t.toFalse=function(){t.showLoad=!1},n.on("scroll",t.scrollFn)}}}),mask.directive("pullRefresh",function(){function t(t,i,o){function a(t,e){for(;(t=t.parentNode)&&t.className!==e;);return t}function r(t){g.get(0).className="icons "+n[t].clz,m.text(n[t].msg)}function s(t){var e=t.originalEvent.changedTouches[0];return{x:e.clientX,y:e.clientY}}function c(){r("touchstart"),p.css("position","absolute")}function u(){r("loadsucc"),setTimeout(c,1e3)}function l(){r("loaderror"),setTimeout(c,1e3)}if(e&&t&&t.pull&&t.isActive){var d,f=angular.element(a(o.get(0),"mask-content")),p=o.find(".loading",o),g=o.find(".icons",o),h=o.find(".x-js-fixed",o),m=o.find(".x-js-msg",o),v=30,y=0,_={x:0,y:0},k={x:0,y:0},T=!1;f.on("touchstart",function(e){d=Date.now(),t.isActive()&&(0===f.scrollTop()&&f.scrollTop(1),v=p.height(),_=s(e),y=0,T=!1)}).on("touchmove",function(e){var n=f.scrollTop();if(!(!t.isActive()||f.scrollTop()>1||(k=s(e),y=k.y-_.y,50>y))){var i=Date.now()-d;50>i||(p.css({position:"static"}),y>=v+20?(r("touchmove"),T=!0):2>n&&r("touchstart"))}}).on("touchend",function(){if(t.isActive()){h.height(v),r("loading");var e;T&&(e=t.pull())&&e.then(u,l),T=!1}})}}var e=!!("ontouchstart"in window),n={loaderror:{clz:"icons_1",msg:"\u5237\u65b0\u5931\u8d25"},loadsucc:{clz:"icons_2",msg:"\u5237\u65b0\u6210\u529f"},loading:{clz:"icons_3",msg:"\u6b63\u5728\u5237\u65b0\u2026"},touchmove:{clz:"icons_4",msg:"\u91ca\u653e\u7acb\u5373\u5237\u65b0"},touchstart:{clz:"icons_5",msg:"\u4e0b\u62c9\u5237\u65b0"}},i=['<div class="loading" style="background-color:initial;height:20px;min-width:290px;position:absolute; top: -1000px;">','<i class="icons"></i><span class="x-js-msg"></span>',"</div>"].join("");return{restrict:"EA",template:i,scope:!1,link:function(e,n,i){var o=e.$eval(i.pullCall);o.pull&&new t(o,e,n)}}}),mask.directive("replyList",function(){return{restrict:"EA",replace:!0,templateUrl:"replyListTpl.html",link:function(t,e,n){t.page=n.page}}}),mask.directive("socialShare",["DeviceApi","MaskDetail","$rootScope","RequestData",function(t,e,n,i){var o=['<div class="mask-bgcolor"></div>','<div class="mask-share">','<span class="share-icon">','<a href="#" action-type="sinaweibo" class="lk_a m-txt3"><i class="icon icon_1"></i>\u65b0\u6d6a\u5fae\u535a</a>','<a href="#" action-type="tecentweibo" class="lk_a m-txt3"><i class="icon icon_2"></i>\u817e\u8baf\u5fae\u535a</a>',"</span>",'<span class="share-btn">','<a href="#" action-type="cancel" ng-click="shareClick=!1" class="lk_a m-txt4">\u53d6\u6d88\u5206\u4eab</a>',"</span>","</div>","</div>"];return{restrict:"E",template:o.join(""),link:function(t,o){function a(t){socialsharing?socialsharing.shareVia(t,e.detail.content,null,null,"",function(){o.addClass("ng-hide"),i.sudaJsonp("21_01_05_"+e.detail.id)},function(){alert("\u5206\u4eab\u5931\u8d25")}):(alert("\u5206\u4eab\u5931\u8d25"),o.addClass("ng-hide"))}var r=o.find('a[action-type="sinaweibo"]'),s=o.find('a[action-type="tecentweibo"]'),c=o.find('a[action-type="cancel"]');r.bind("touch click",function(){a("com.apple.social.sinaweibo")}),s.bind("touch click",function(){a("com.apple.social.tencentweibo")}),c.bind("touch click",function(){o.addClass("ng-hide")}),n.$on("share_btn_touch",function(){o.removeClass("ng-hide")}),o.addClass("ng-hide")}}}]),mask.controller("AddCmtCtrl",["API","Map","Sence","$http","$scope","MaskDetail","ListData",function(t,e,n,i,o,a,r){var s=this;s.isSubmit=!1,s.mask={content:""},s.addCmt=function(){s.isSubmit||(s.isSubmit=!0,e.getCurrentPos().then(function(e){i.post(t.ADD_CMT,{secrectId:a.detail.id,content:s.mask.content,longitude:e.longitude,latitude:e.latitude}).success(function(t){if(s.isSubmit=!1,"A00006"===t.code){n.back(),s.reset(),r.replys.unshift(t.data);var e=s.getById(a.detail.id);e.cmtCount=parseInt(e.cmtCount,10)+1}alert(t.message)}).error(function(){s.isSubmit=!1,alert("\u63d0\u4ea4\u5931\u8d25")})},function(){s.isSubmit=!1}))},s.getById=function(t){for(var e=r.lists,n=e.length-1;n>=0;n--)if(e[n].id==t)return e[n]},s.reset=function(){o.cmtForm.$setPristine(),s.mask.content="",s.isSubmit=!1}}]),mask.controller("AddMaskCtrl",["API","Map","Sence","$http","$scope","$rootScope","ListData",function(t,e,n,i,o,a,r){var s=this;s.isSubmit=!1,s.mask={content:""},s.addMask=function(){s.isSubmit||(s.isSubmit=!0,e.getCurrentPos().then(function(e){i.post(t.ADD_MASK,{content:s.mask.content,longitude:e.longitude,latitude:e.latitude}).success(function(t){s.isSubmit=!1,"A00006"===t.code&&(n.back(),s.reset(),t.data.isMe=!0,r.lists.unshift(t.data)),alert(t.message)}).error(function(){s.isSubmit=!1,alert("\u63d0\u4ea4\u5931\u8d25")})},function(){s.isSubmit=!1}))},s.reset=function(){o.maskForm.$setPristine(),s.mask.content="",s.isSubmit=!1}}]),mask.controller("HomeCtrl",["$scope","RequestData","UserData","MaskDetail","Map","MaskListType","API","ListData","$q","$rootScope","Sence","DeviceReady","PushNotification","$http",function(t,e,n,i,o,a,r,s,c,u,l,d,f,p){function g(t){return o.getCurrentPos().then(function(n){var i=o.getDiagonalPoints(n),a={uniqueid:t.uniqueid||"",id:t.id||"",type:t.type,page:t.page||1,dir:t.dir||0,pagesize:t.pageSzie||20,latitudeone:i.northEastPos.latitude,longitudeone:i.northEastPos.longitude,latitudetwo:i.southWestPos.latitude,longitudetwo:i.southWestPos.longitude,latitudethree:i.currentPos.latitude,longitudethree:i.currentPos.longitude},r={method:"POST",url:t.url,data:a};return e.loadData(r)})}function h(){if(window.cordova)if(window.device&&window.device.uuid){var t=f(m);t?t.then(function(t){log("Get token pre 20:",t.substring(0,20)),v.login(device.uuid,{token:t})},function(){log("Get token error"),v.login(device.uuid)}):v.login(device.uuid)}else log("\u8bbe\u5907id\u6216\u5931\u8d25"),v.login("zhihang1");else v.login("zhihang1")}function m(e){setTimeout(function(){try{t.$apply(function(){l.changePage("detail"),i.detail={longitude:e.lng,latitude:e.lat,id:e.sid}})}catch(n){log(n.stack)}},500)}var v=this;v.networkError=!1,v.hasNoData=!1,v.loadMore=!1,t.loading=!0,v.lists=[];var y=0;v.login=function(e,i){return y++,y>3?(v.networkError=!1,t.loading=!1,void 0):(i=i||{},g({url:r.ADD_USER,type:1,page:1,uniqueid:e}).then(function(o){if("A00006"===o.code||"A00008"===o.code){var a={session_id:o.data.session_id,user_info:o.data.user_info};n.data=a;var c=o.data.secret_info.list;v.loadMore=o.data.secret_info.total>20?!0:!1,s.lists=s.lists.concat(c),t.loading=!1;var u=a.user_info&&parseInt(a.user_info.pushalert,10);!u&&i.token&&p.post(r.SEND_TOKEN,{token:i.token}).success(function(t){log("send token success: ",t)}).error(function(){})}else v.login(e)},function(){v.networkError=!1,t.loading=!1}),void 0)},v.loadList=function(e){g({url:r.GET_LIST,type:1,dir:2,id:e}).then(function(e){var n=e.data.list;v.loadMore=20==n.length?!0:!1,s.lists=s.lists.concat(n),t.loading=!1},function(){t.loading=!1})},v.nextPage=function(){var e=v.lists[v.lists.length-1].id;v.loadMore=!1,t.loading=!0,v.loadList(e)},v.getById=function(t){for(var e=s.lists,n=e.length-1;n>=0;n--){var i=parseInt(e[n].id,10);if(i===t)return e[n]}},v.up=function(t){var i=v.getById(t);return 1==i.attitude?(alert("\u60a8\u5df2\u7ecf\u9876\u8fc7\uff01"),void 0):2==i.attitude?(alert("\u60a8\u5df2\u7ecf\u8e29\u8fc7\uff01"),void 0):(i.attitude=1,i.score+=1,n.data.user_info.score=parseInt(n.data.user_info.score,10)+1,e.addSecretAtt(t,1).then(function(){},function(){}),void 0)},v.down=function(t){var n=v.getById(t);if(1==n.attitude)return alert("\u60a8\u5df2\u7ecf\u9876\u8fc7\uff01"),void 0;if(2==n.attitude)return alert("\u60a8\u5df2\u7ecf\u8e29\u8fc7\uff01"),void 0;var n=v.getById(t);n.attitude=2,n.score-=1,-10>=n.score&&v.delSecret(t),e.addSecretAtt(t,2).then(function(){},function(){})},v.delSecret=function(t){for(var e=s.lists,n=e.length-1;n>=0;n--){var i=parseInt(e[n].id,10);if(i===t){e.splice(n,1);break}}},v.setDetail=function(t){i.detail=v.getById(t),e.sudaJsonp("21_01_02_"+t)},v.isActive=function(){return 1===a.currentType&&"home"===l.currentPage},v.pull=function(){function e(t){for(var e,n=0;t.length>n;n++)if(e=t[n],!e.isMe)return e;return null}function n(t){for(var e,n=0;t.length>n;n++)e=t[n],e.isMe&&(t.splice(n,1),n--)}if(v.isActive()){var i=c.defer(),o={},a=s.lists,u=e(a);return u?o={url:r.GET_LIST,type:1,dir:1,id:u.id}:(u={id:0},o={url:r.GET_LIST,type:1,page:1}),g(o).then(function(e){if("A00006"===e.code){var o,r=e.data.list,c=10;if(a.length>0&&u)for(var l=r.length-1;l>=0;l--)o=r[l],parseInt(u.id)>parseInt(o.id,10)&&r.pop();r.length>=c?v.lists=s.lists=[].concat(r):(n(s.lists),v.lists=s.lists=r.concat(s.lists)),i.resolve()}else i.reject();t.loading=!1},function(){t.loading=!1,i.reject()}),i.promise}},v.reRun=function(){t.loading=!0,v.networkError=!1,d.reRun()},t.$watch(function(){return s.lists},function(t){0!=t.length&&(v.lists=t)},!0),d.then(function(){h();var t=function(t){o.getCurrentPos().then(function(i){var o="21_01_01_"+n.data.id+"_"+i.latitude+"_"+i.longitude+"_"+t;e.sudaJsonp(o)})},i=function(){t("pause")},a=function(){t("resume")};document.addEventListener("pause",i,!1),document.addEventListener("resume",a,!1),window.onerror=function(t){log(t.stack)};var r;$("a.tabs-a.recently").on("touchstart",function(){r=Date.now()}).on("touchend",function(){var t=Date.now()-r;t>15e3?$("#log").show():$("#log").hide()})},function(){t.loading=!1,v.networkError=!0})}]),mask.controller("HotListCtrl",["$rootScope","$scope","$http","MaskDetail","Map","RequestData","UserData","Sence","API","Recomment","$q",function(t,e,n,i,o,a,r,s,c,u,l){var d=this,f=1;d.loadMore=!1,e.loading=!0,d.hasNoData=!1,d.isLoading=!1,d.title="",d.lists=[],d.getById=function(t){for(var e=d.lists,n=e.length-1;n>=0;n--){var i=parseInt(e[n].id,10);if(i===t)return e[n]}},d.up=function(t){var e=d.getById(t);return 1==e.attitude?(alert("\u60a8\u5df2\u7ecf\u9876\u8fc7\uff01"),void 0):2==e.attitude?(alert("\u60a8\u5df2\u7ecf\u8e29\u8fc7\uff01"),void 0):(e.attitude=1,e.score+=1,r.data.user_info.score=parseInt(r.data.user_info.score,10)+1,a.addSecretAtt(t,1).then(function(){},function(){}),void 0)},d.down=function(t){var e=d.getById(t);if(1==e.attitude)return alert("\u60a8\u5df2\u7ecf\u9876\u8fc7\uff01"),void 0;if(2==e.attitude)return alert("\u60a8\u5df2\u7ecf\u8e29\u8fc7\uff01"),void 0;var e=d.getById(t);e.attitude=2,e.score-=1,-10>=e.score&&d.delSecret(t),a.addSecretAtt(t,2).then(function(){},function(){})},d.delSecret=function(t){for(var e=d.lists,n=e.length-1;n>=0;n--){var i=parseInt(e[n].id,10);if(i===t){e.splice(n,1);break}}},d.setDetail=function(t){i.detail=d.getById(t),a.sudaJsonp("21_01_03_"+t)},d.reset=function(){d.loadMore=!1,e.loading=!0,d.isLoading=!0,d.hasNoData=!1,d.lists=[]},d.loadList=function(t,i){d.title=t.value,i=i||1;var o="place"===t.type?c.GET_HOT_PLACE_LIST:c.GET_HOT_TOPIC_LIST;n.post(o,{id:t.id,page:i,pagesize:10}).success(function(t){if("A00006"==t.code){var n=t.data.list;d.loadMore=10==n.length?!0:!1,d.lists=d.lists.concat(n),e.loading=!1,d.hasNoData=d.lists.length?!1:!0}else alert("\u6570\u636e\u52a0\u8f7d\u51fa\u9519")}).error(function(){alert("\u6570\u636e\u52a0\u8f7d\u51fa\u9519")})},d.nextPage=function(){f++,d.loadMore=!1,e.loading=!0,d.loadList(u,f)},d.isActive=function(){return"hotlist"===s.currentPage},d.pull=function(){function t(t){for(var e,n=0;t.length>n;n++)if(e==t[n],e)return e;return null}if(d.isActive()){var e=l.defer(),i={},o=d.lists,a=t(o),r="place"===u.type?c.GET_HOT_PLACE_LIST:c.GET_HOT_TOPIC_LIST;return i=a?{type:1,dir:1,id:a.id}:{type:1,page:1},n.post(r,{id:u.id,dir:1,pagesize:10}).success(function(t){if("A00006"===t.code){var n,i=t.data.list,r=10;if(o.length>0&&a)for(var s=i.length-1;s>=0;s--)n=i[s],parseInt(a.id)>parseInt(n.id,10)&&i.pop();d.lists=i.length>=r?[].concat(i):i.concat(d.lists),e.resolve()}else e.reject()}).error(function(){e.reject()}),e.promise}},e.$watch(function(){return u},function(t,e){(t.id!==e.id||t.type!==e.type)&&(d.reset(),d.loadList(t))},!0)}]),mask.controller("HotRecommentCtrl",["$rootScope","$scope","$http","API","MaskListType","Recomment","$q","Sence","RequestData",function(t,e,n,i,o,a,r,s,c){var u=this;u.placeList=[],u.topicList=[],e.loading=!0,u.load=function(t){e.loading=!0,t=t||{};var o=t.defer;n.post(i.GET_HOT_RECOMMENT,{page:1,pagesize:20}).success(function(t){"A00006"===t.code?(e.loading=!1,u.placeList=t.data.place_info,u.topicList=t.data.topic_info,o&&o.resolve()):(o&&o.reject(),e.loading=!1)}).error(function(){o&&o.reject(),e.loading=!1})},u.setRecomment=function(t,e,n){a.change(t,e,n),c.sudaJsonp("21_01_04_"+e)},u.isActive=function(){return 2===o.currentType&&"home"===s.currentPage},u.pull=function(){if(u.isActive()){var t=r.defer();return u.load({defer:t}),t.promise}},e.$watch(function(){return o.currentType},function(t){2===t&&u.load()})}]),mask.controller("MaskDetailCtrl",["$scope","MaskDetail","Map","RequestData","UserData","API","ListData","Sence",function(t,e,n,i,o,a,r,s){function c(t){r.replys=[],u.setCoords(t.latitude,t.longitude),u.loadReply({sid:t.id}),u.str=1==t.isme?"\u5220\u9664":"\u4e3e\u62a5"}var u=this;u.loadMore=!1,u.loading=!0,u.lists=[],u.starImg=!1,u.isSubmit=!1,u.setCoords=function(t,e){if(200==e)u.starImg=!0;else{u.starImg=!1;var i={latitude:t,longitude:e};n.setMarker(i)}},u.getById=function(t){for(var e=r.replys,n=e.length-1;n>=0;n--){var i=parseInt(e[n].id,10);if(i===t)return e[n]}},u.delById=function(t,e){for(var n=e,i=n.length-1;i>=0;i--)if(n[i].id==t)return n.splice(i,1)},u.up=function(t){var e=u.getById(t);return 1==e.attitude?(alert("\u60a8\u5df2\u7ecf\u9876\u8fc7\uff01"),void 0):2==e.attitude?(alert("\u60a8\u5df2\u7ecf\u8e29\u8fc7\uff01"),void 0):(e.attitude=1,e.score+=1,o.data.user_info.score=parseInt(o.data.user_info.score,10)+1,i.addCmtAtt(t,1).then(function(){},function(){}),void 0)},u.down=function(t){var e=u.getById(t);if(1==e.attitude)return alert("\u60a8\u5df2\u7ecf\u9876\u8fc7\uff01"),void 0;if(2==e.attitude)return alert("\u60a8\u5df2\u7ecf\u8e29\u8fc7\uff01"),void 0;var e=u.getById(t);e.attitude=2,e.score-=1,-10>=e.score&&u.delSecret(t),i.addCmtAtt(t,2).then(function(){},function(){})},u.delComment=function(t){u.delById(t,r.replys)},u.loadReply=function(t){var e={page:t.page||1,size:t.size||10,sid:t.sid,id:t.id||"",dir:t.dir||0},n={method:"POST",url:a.GET_CMT_LIST,data:e};i.loadData(n).then(function(t){if(t.data.list){var e=t.data.list;u.loadMore=10==e.length?!0:!1,r.replys=r.replys.concat(e)}u.loading=!1,u.hasNoData=r.replys.length?!1:!0},function(){})},u.nextPage=function(){u.loadMore=!1,u.loading=!0,u.loadReply({sid:e.detail.id,id:u.lists[u.lists.length-1].id,dir:2})},u.httpPromise=function(t){var e={method:"POST",url:t.url,data:t.postData};return i.loadData(e)},u.handler=function(t){u.isSubmit||(u.isSubmit=!0,window.confirm("\u786e\u5b9a\u8981"+t+"\u8fd9\u6761\u79d8\u5bc6\u5417\uff1f",function(n){return 1!==n?(u.isSubmit=!1,void 0):("\u5220\u9664"==t?u.httpPromise({url:a.DEL_SECRET,postData:{sid:e.detail.id}}).then(function(t){alert(t.message),u.delById(e.detail.id,r.lists),s.back(),u.isSubmit=!1},function(t){alert(t.message),u.isSubmit=!1}):u.httpPromise({url:a.ADD_SECRET_REPORT,postData:{secretid:e.detail.id}}).then(function(t){alert(t.message),u.isSubmit=!1},function(t){alert(t.message),u.isSubmit=!1}),void 0)}))},t.$watch(function(){return e.detail},function(t){isNaN(t.latitude)||c(t)},!0),t.$watch(function(){return r.replys},function(t){u.lists=t},!0)}]),mask.controller("MoreCtrl",["$scope","RequestData","UserData","MoreData","API",function(t,e,n,i){var o=this;o.setType=function(t){i.type=t}}]),mask.controller("MyListCtrl",["$scope","MoreData","MaskDetail","RequestData","API","Sence","$q",function(t,e,n,i,o){var a=this,r=1;a.hasNoData=!1,a.loadMore=!1,t.loading=!0,a.lists=[],a.loadList=function(e){var n={page:e,size:10},r={method:"POST",url:o.GET_MY_SECRET_LIST,data:n};i.loadData(r).then(function(e){var n=e.data.list;a.loadMore=10==n.length?!0:!1,a.lists=a.lists.concat(n),t.loading=!1,a.hasNoData=a.lists.length?!1:!0},function(){})},a.nextPage=function(){r++,t.loading=!0,a.loadMore=!1,a.loadList(r)},a.setDetail=function(t){for(var e=a.lists,i=e.length-1;i>=0;i--){var o=parseInt(e[i].id,10);if(o===t){n.detail=e[i];break}}},t.$watch(function(){return e.type},function(t){"secret"==t&&(e.type="",a.lists=[],r=1,a.loadList(r))})}]),mask.controller("MyReplyCtrl",["$scope","MoreData","RequestData","API","MaskDetail",function(t,e,n,i){var o=this,a=1;o.hasNoData=!1,o.loadMore=!1,o.loading=!0,o.lists=[],o.loadList=function(t){var e={page:t,size:10},a={method:"POST",url:i.GET_MY_LIST,data:e};n.loadData(a).then(function(t){var e=t.data.list;o.loadMore=10==e.length?!0:!1,o.lists=o.lists.concat(e),o.loading=!1,o.hasNoData=o.lists.length?!1:!0},function(){})},o.nextPage=function(){a++,o.loading=!0,o.loadMore=!1,o.loadList(a)},t.$watch(function(){return e.type},function(t){"reply"==t&&(e.type="",o.lists=[],a=1,o.loadList(a))},!0)}]),mask.controller("SenceChangeCtrl",["$rootScope","$scope","Sence","MaskListType","UserData",function(t,e,n,i,o){var a=this;a.sence=n,a.tab=i,a.toggle=function(t){n.changePage(t)},a.back=function(){n.back()},a.isPage=function(t){return a.sence.currentPage===t},a.share=function(){t.$broadcast("share_btn_touch")},a.setTab=function(t){i.changeType(t)},a.isTabSelect=function(t){return t===a.tab.currentType},e.$watch(function(){return o.data},function(t){void 0!==t.user_info&&(a.userData=t)},!0)}]),mask.controller("UpdateNickCtrl",["API","Sence","$http","$scope","UserData",function(t,e,n,i,o){var a=this;a.nick="",a.isSubmit=!1,a.updateNick=function(){n.post(t.UPDATE_NICK,{nickname:a.nick}).success(function(t){a.isSubmit=!0,"A00006"===t.code&&(e.back(),a.reset(),o.data.nickname=a.nickname),alert(t.message)}).error(function(){a.isSubmit=!0,alert("\u63d0\u4ea4\u5931\u8d25")})},a.reset=function(){},i.$watch(function(){return o.data},function(t){a.nick=t.user_info&&t.user_info.nickname?t.user_info.nickname:""
},!0)}]);